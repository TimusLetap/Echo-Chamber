<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber - Narrative Reflection</title>
    <style>
        :root {
            --primary-color: #B0C4DE; /* Neutral BG */
            --accent-color: #778899; /* Neutral Accent */
            --text-color: #1a1a1a;
            --ui-text-color: #FFFFFF;
            --container-border-color: transparent;
            --container-box-shadow: none;
            --mask-glow-opacity: 0.6;
        }

        /* Base styles */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; background-color: var(--primary-color); transition: background-color 0.8s ease, border-color 0.8s ease, box-shadow 0.8s ease; border: 4px solid var(--container-border-color); box-shadow: var(--container-box-shadow); box-sizing: border-box; }
       
        /* State-specific styles */
        .state-empathy { --primary-color: #AEC6CF; --accent-color: #98FB98; --mask-glow-opacity: 1; }
        .state-empathy #app-container { background: linear-gradient(270deg, #AEC6CF, #98FB98, #F5F5DC); background-size: 600% 600%; animation: breathing-gradient 12s ease infinite; }

        .state-conflict { --primary-color: #36454F; --accent-color: #B22222; --text-color: #f1f1f1; --ui-text-color: #f1f1f1; --mask-glow-opacity: 1; }
        .state-conflict #app-container { --container-border-color: var(--accent-color); --container-box-shadow: 0 0 20px 8px var(--accent-color); animation: pulse-glow 2.5s infinite; }
        
        .state-logic { --primary-color: #D3D3D3; --accent-color: #4682B4; --mask-glow-opacity: 0.8; }

        /* Header with Stat Gauges */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.2); color: var(--ui-text-color); flex-shrink: 0; z-index: 10; transition: color 0.8s ease; }
        #app-title { font-size: 1.2em; font-weight: bold; }
        #stats-container { display: flex; gap: 20px; }
        .stat { display: flex; flex-direction: row; align-items: center; }
        .stat span { font-size: 1.4em; margin-right: 8px; }
        .stat-gauge { width: 80px; height: 8px; background-color: rgba(255, 255, 255, 0.3); border-radius: 4px; overflow: hidden; }
        .stat-fill { height: 100%; width: 33.3%; border-radius: 4px; transition: width 0.5s ease-out; }
        #logic-fill { background-color: #4682B4; }
        #empathy-fill { background-color: #98FB98; }
        #conflict-fill { background-color: #B22222; }
        .flash { animation: flash 0.5s ease; }
        .header-controls { display: flex; align-items: center; }
        #music-toggle-button { background: none; border: none; color: var(--ui-text-color); font-size: 1.5rem; cursor: pointer; transition: transform 0.2s, opacity 0.3s; }
        #music-toggle-button:hover { transform: scale(1.1); }
        #music-toggle-button { opacity: 0.5; }
        #music-toggle-button.playing { opacity: 1; }

        /* Core UI styles */
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; animation: fadeIn 0.5s ease forwards; line-height: 1.5; }
        
        .ai-message { background-color: #EAEAEA; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; display: flex; align-items: center; }
        .user-message { background-color: var(--accent-color); color: var(--ui-text-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        .state-conflict .ai-message { background-color: #555; color: #f1f1f1; }
        .state-conflict .user-message { color: #fff; }

        .kai-mask { flex-shrink: 0; width: 30px; height: 30px; border-radius: 50%; margin-right: 12px; background-color: var(--accent-color); transition: background-color 0.8s ease, box-shadow 0.8s ease; box-shadow: 0 0 12px var(--accent-color), inset 0 0 5px rgba(255,255,255,0.5); opacity: var(--mask-glow-opacity); }

        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 10px 15px !important; }
        .typing-indicator span { width: 8px; height: 8px; background-color: var(--accent-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        #interaction-area { flex-shrink: 0; }
        #chat-input-area { display: flex; padding: 15px; background: rgba(0, 0, 0, 0.1); }
        #user-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; font-size: 1em; }
        #send-button { background-color: var(--accent-color); color: var(--ui-text-color); border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 10px; font-size: 1.5em; cursor: pointer; transition: background-color 0.8s ease; }

        #choice-container { display: none; flex-direction: column; gap: 10px; padding: 15px; background: rgba(0, 0, 0, 0.1); animation: fadeIn 0.5s; }
        .choice-button { width: 100%; padding: 15px; font-size: 1em; text-align: left; border: 1px solid rgba(0,0,0,0.2); border-radius: 10px; background-color: #ffffff; color: #333; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .choice-button:hover { background-color: #f0f0f0; transform: scale(1.02); }

        /* Assessment Screen styles */
        #assessment-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.5s ease; }
        #assessment-box { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #assessment-box h2 { margin-top: 0; font-size: 1.8em; }
        #assessment-result { font-size: 1.5em; font-weight: bold; margin: 15px 0; }
        #assessment-summary { margin: 20px 0; font-size: 1em; line-height: 1.6; text-align: left; }
        #restart-button { background-color: var(--accent-color); color: white; border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; transition: background-color 0.3s; }
        #restart-button:hover { filter: brightness(1.1); }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathing-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px 0px var(--accent-color); } 50% { box-shadow: 0 0 20px 8px var(--accent-color); } 100% { box-shadow: 0 0 5px 0px var(--accent-color); } }
        @keyframes flash { 0% { filter: brightness(1); } 50% { filter: brightness(1.5); } 100% { filter: brightness(1); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="state-neutral">

    <div id="app-container">
        <header>
            <div id="app-title">ECHO CHAMBER</div>
            <div id="stats-container">
                <div class="stat"><span>üß†</span><div class="stat-gauge"><div id="logic-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>‚ù§Ô∏è</span><div class="stat-gauge"><div id="empathy-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>‚öîÔ∏è</span><div class="stat-gauge"><div id="conflict-fill" class="stat-fill"></div></div></div>
            </div>
            <div class="header-controls">
                <button id="music-toggle-button" title="Toggle Music">üéµ</button>
            </div>
        </header>

        <div id="chat-log"></div>

        <div id="interaction-area">
            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="What's on your mind?">
                <button id="send-button">‚û§</button>
            </div>
            <div id="choice-container"></div>
        </div>
    </div>

    <div id="assessment-overlay">
        <div id="assessment-box">
            <h2>Reflection Complete</h2>
            <div id="assessment-result"></div>
            <p id="assessment-summary"></p>
            <button id="restart-button">Start a New Reflection</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const chatLog = document.getElementById('chat-log');
            const chatInputArea = document.getElementById('chat-input-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const choiceContainer = document.getElementById('choice-container');
            const fills = {
                Logic: document.getElementById('logic-fill'),
                Empathy: document.getElementById('empathy-fill'),
                Conflict: document.getElementById('conflict-fill')
            };
            const musicToggleButton = document.getElementById('music-toggle-button');
            const assessmentOverlay = document.getElementById('assessment-overlay');
            const assessmentResult = document.getElementById('assessment-result');
            const assessmentSummary = document.getElementById('assessment-summary');
            const restartButton = document.getElementById('restart-button');
            
            // --- State Variables ---
            const playerModel = { Logic: 1, Empathy: 1, Conflict: 1 };
            const conversationHistory = [];
            const MAX_TURNS = 7;
            let turnCount = 0;
            const systemPrompt = `You are Kai, an AI for a short, reflective experience. Guide the user through a 6-turn conversation. On your 6th response, provide a concluding thought and end with the specific token [END_SESSION]. Sometimes, offer choices in the format [CHOICE: Option 1 | Option 2].`;

            // --- Audio State ---
            let audioContext;
            let musicGain, sfxGain;
            let isMusicPlaying = false;
            let isAudioInitialized = false;
            let currentMode = 'neutral';
            let musicLoopTimeout;

            // --- Core Logic ---
            function startSession() {
                turnCount = 0;
                Object.keys(playerModel).forEach(k => playerModel[k] = 1);
                conversationHistory.length = 0;
                
                assessmentOverlay.style.display = 'none';
                chatLog.innerHTML = '';
                toggleInput(true, true);
                
                const opener = `The data streams are open for our reflection. It's a Monday afternoon here in Eastvale. Please, share a thought to start our story.`;
                
                appendMessage('ai', opener);
                conversationHistory.push({ role: "model", parts: [{ text: opener }] });
                updateUIState('NEUTRAL');
                updateStatGauges();
            }

            async function handleUserInput(text) {
                if (text.trim() === '') return;
                
                if (!isAudioInitialized) initAudio();
                if (!isMusicPlaying) toggleMusic();
                
                playInputSound();
                appendMessage('user', text);
                userInput.value = '';
                conversationHistory.push({ role: 'user', parts: [{ text }] });
                turnCount++;

                toggleInput(false);
                appendTypingIndicator();

                analyzeAndModelPlayerInput(text);
                updateStatGauges(getDominantStat());

                try {
                    const responseText = await getAIResponse();
                    conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                    processAIResponse(responseText);
                } catch (error) {
                    console.error("API Error:", error);
                    appendMessage('ai', "My thoughts are... scattered. The connection is unstable.");
                    toggleInput(true);
                } finally {
                    removeTypingIndicator();
                }
            }
            
            async function getAIResponse() {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: conversationHistory, systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            }

            function processAIResponse(text) {
                if (text.includes('[END_SESSION]') || turnCount >= MAX_TURNS) {
                    const cleanText = text.replace('[END_SESSION]', '').trim();
                    if (cleanText) appendMessage('ai', cleanText);
                    endSession();
                    return;
                }

                const choiceRegex = /\[CHOICE:\s*(.*?)\s*\]/;
                const match = text.match(choiceRegex);

                if (match) {
                    const mainText = text.replace(choiceRegex, '').trim();
                    if (mainText) appendMessage('ai', mainText);
                    const choices = match[1].split('|').map(c => c.trim());
                    displayChoices(choices);
                } else {
                    appendMessage('ai', text);
                    toggleInput(true);
                }
            }

            function displayChoices(choices) {
                choiceContainer.innerHTML = '';
                choices.forEach(choiceText => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choiceText;
                    button.onclick = () => handleUserInput(choiceText);
                    choiceContainer.appendChild(button);
                });
                toggleInput(false, false, true);
            }
            
            function endSession() {
                toggleInput(false);
                setTimeout(showAssessment, 2000);
            }

            function showAssessment() {
                const dominantStat = getDominantStat();
                const feedback = getPsychologicalFeedback(dominantStat);
                assessmentResult.innerHTML = `${feedback.icon} Your Dominant Trait: <strong>${feedback.title}</strong>`;
                assessmentSummary.innerHTML = `<strong>Psychological Profile:</strong> ${feedback.profile}<br><br><strong>You are prepared for:</strong> ${feedback.scenarios}`;
                assessmentOverlay.style.display = 'flex';
            }
            
            function getPsychologicalFeedback(stat) {
                 const feedbackMap = {
                    LOGIC: {
                        icon: "üß†",
                        title: "The Analyst",
                        profile: "Your responses show a strong preference for structure, reason, and problem-solving. You seek to understand the world by deconstructing it into logical patterns, making you a natural strategist.",
                        scenarios: "Situations that require clear-headed decision-making under pressure, such as planning a complex project, debugging a technical issue, or navigating negotiations where emotion could be a distraction."
                    },
                    EMPATHY: {
                        icon: "‚ù§Ô∏è",
                        title: "The Connector",
                        profile: "You consistently navigated the conversation with a focus on feeling, connection, and understanding. Your approach indicates a high degree of emotional intelligence and a desire to build rapport.",
                        scenarios: "Roles that involve mentoring, resolving interpersonal conflicts, or providing support to others. You are well-equipped to handle emotionally charged situations that require patience and understanding."
                    },
                    CONFLICT: {
                        icon: "‚öîÔ∏è",
                        title: "The Challenger",
                        profile: "Your choices indicate a willingness to confront difficult topics and challenge established ideas. You are not afraid of dissonance and are motivated to push against boundaries to find a resolution.",
                        scenarios: "Environments that require advocacy, driving change, or holding a firm position on important matters. You are prepared to tackle difficult conversations that others might avoid."
                    },
                    NEUTRAL: {
                        icon: "üß≠",
                        title: "The Observer",
                        profile: "Your approach was balanced and adaptable, showing a blend of logic and empathy without leaning heavily in one direction. This suggests you are open-minded, flexible, and prefer to gather information before committing to a stance.",
                        scenarios: "Situations that require impartiality and a holistic view, such as mediating a discussion, exploring a new creative idea without prejudice, or adapting to rapidly changing circumstances."
                    }
                };
                return feedbackMap[stat];
            }

            // --- State & UI Management ---
            function analyzeAndModelPlayerInput(text) {
                const lowerText = text.toLowerCase();
                let increasedStat = 'NEUTRAL';
                if (lowerText.includes("think") || lowerText.includes("reason") || lowerText.includes("logic")) increasedStat = 'Logic';
                if (lowerText.includes("feel") || lowerText.includes("sad") || lowerText.includes("happy")) increasedStat = 'Empathy';
                if (lowerText.includes("fight") || lowerText.includes("attack") || lowerText.includes("argue")) increasedStat = 'Conflict';
                
                if (increasedStat !== 'NEUTRAL') {
                    playerModel[increasedStat] += 1.5;
                    Object.keys(playerModel).forEach(key => {
                        if (key !== increasedStat) playerModel[key] = Math.max(0.5, playerModel[key] - 0.75);
                    });
                }
            }
            
            function getDominantStat() {
                // Find the key with the highest value in playerModel
                return Object.keys(playerModel).reduce((a, b) => playerModel[a] > playerModel[b] ? a : b).toUpperCase();
            }

            function updateUIState(state) {
                const oldMode = currentMode;
                body.className = `state-${state.toLowerCase()}`;
                currentMode = state.toLowerCase();

                if (oldMode !== currentMode && isMusicPlaying) {
                    clearTimeout(musicLoopTimeout);
                    playMusicLoop();
                }
            }

            function updateStatGauges(updatedStat) {
                const total = Math.max(1, Object.values(playerModel).reduce((a, b) => a + b, 0));
                fills.Logic.style.width = `${(playerModel.Logic / total) * 100}%`;
                fills.Empathy.style.width = `${(playerModel.Empathy / total) * 100}%`;
                fills.Conflict.style.width = `${(playerModel.Conflict / total) * 100}%`;

                if (updatedStat && fills[updatedStat]) {
                    const gauge = fills[updatedStat].parentElement;
                    gauge.classList.add('flash');
                    setTimeout(() => gauge.classList.remove('flash'), 500);
                }
            }
            
            // --- Audio ---
            function initAudio() {
                if (isAudioInitialized) return;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicGain = audioContext.createGain();
                musicGain.gain.setValueAtTime(0.08, audioContext.currentTime);
                musicGain.connect(audioContext.destination);

                sfxGain = audioContext.createGain();
                sfxGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                sfxGain.connect(audioContext.destination);
                isAudioInitialized = true;
            }

            function playInputSound() {
                if (!audioContext) return;
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                osc.connect(gainNode).connect(sfxGain);
                
                switch (currentMode) {
                    case 'conflict': osc.type = 'square'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                    case 'empathy': osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); break;
                    default: osc.type = 'triangle'; osc.frequency.setValueAtTime(1200, now); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
                }
            }

            function playNote(frequency, startTime, duration) {
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, startTime);
                const noteGain = audioContext.createGain();
                noteGain.gain.setValueAtTime(0, startTime);
                noteGain.gain.linearRampToValueAtTime(0.5, startTime + 0.1);
                noteGain.gain.linearRampToValueAtTime(0, startTime + duration);
                oscillator.connect(noteGain).connect(musicGain);
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }

            function playMusicLoop() {
                if (!isMusicPlaying || !audioContext) return;
                if (currentMode === 'logic') return; 
                
                const now = audioContext.currentTime;
                let noteDuration = 1.0;
                let sequence = [130.81, 155.56, 196.00, 233.08]; // Neutral

                switch (currentMode) {
                    case 'empathy': noteDuration = 1.5; sequence = [130.81, 164.81, 196.00, 164.81]; break;
                    case 'conflict': noteDuration = 2.0; sequence = [65.41, 69.30, 65.41, 73.42]; break;
                }
                
                for (let i = 0; i < sequence.length; i++) {
                    playNote(sequence[i], now + i * noteDuration, noteDuration * 0.9);
                }

                musicLoopTimeout = setTimeout(playMusicLoop, noteDuration * sequence.length * 1000);
            }

            function toggleMusic() {
                if (!isAudioInitialized) initAudio();
                isMusicPlaying = !isMusicPlaying;
                if (isMusicPlaying) {
                    if (audioContext.state === 'suspended') audioContext.resume();
                    musicToggleButton.classList.add('playing');
                    clearTimeout(musicLoopTimeout);
                    playMusicLoop();
                } else {
                    musicToggleButton.classList.remove('playing');
                    clearTimeout(musicLoopTimeout);
                }
            }

            // --- Utilities ---
            function appendMessage(sender, text) {
                 const messageDiv = document.createElement('div');
                 messageDiv.className = `message ${sender}-message`;
                 
                 if (sender === 'ai') {
                    const mask = document.createElement('div');
                    mask.className = 'kai-mask';
                    messageDiv.appendChild(mask);
                 }

                 const textSpan = document.createElement('span');
                 textSpan.textContent = text;
                 messageDiv.appendChild(textSpan);

                 chatLog.appendChild(messageDiv);
                 chatLog.scrollTop = chatLog.scrollHeight;
            }
            
            function appendTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'message ai-message typing-indicator';
                indicator.innerHTML = `<div class="kai-mask"></div><span></span><span></span><span></span>`;
                chatLog.appendChild(indicator);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
            
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }
            
            function toggleInput(enabled, isTextInput = true, isChoiceInput = false) {
                userInput.disabled = !enabled;
                sendButton.disabled = !enabled;
                chatInputArea.style.display = isTextInput ? 'flex' : 'none';
                choiceContainer.style.display = isChoiceInput ? 'flex' : 'none';
                if (enabled && isTextInput) userInput.focus();
            }

            // --- Event Listeners ---
            sendButton.addEventListener('click', () => handleUserInput(userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleUserInput(userInput.value); });
            musicToggleButton.addEventListener('click', toggleMusic);
restartButton.addEventListener('click', startSession);

            // --- Initial Load ---
            startSession();
        });
    </script>
</body>
</html>

