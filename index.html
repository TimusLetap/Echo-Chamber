<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber - Narrative Reflection</title>
    <style>
        :root {
            --primary-color: #B0C4DE; /* Neutral BG */
            --accent-color: #778899; /* Neutral Accent */
            --text-color: #1a1a1a;
            --ui-text-color: #FFFFFF;
            --container-border-color: transparent;
            --container-box-shadow: none;
        }

        /* Base styles */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; background-color: var(--primary-color); transition: background-color 0.8s ease, border-color 0.8s ease, box-shadow 0.8s ease; border: 4px solid var(--container-border-color); box-shadow: var(--container-box-shadow); box-sizing: border-box; }
       
        /* State-specific styles */
        .state-empathy { --primary-color: #AEC6CF; --accent-color: #98FB98; }
        .state-empathy #app-container { animation: breathing-gradient 12s ease infinite; }

        .state-conflict { --primary-color: #36454F; --accent-color: #B22222; --text-color: #f1f1f1; --ui-text-color: #f1f1f1;}
        .state-conflict #app-container { --container-border-color: var(--accent-color); --container-box-shadow: 0 0 20px 8px var(--accent-color); animation: pulse-glow 2.5s infinite; }
        
        .state-logic { --primary-color: #D3D3D3; --accent-color: #4682B4; }

        /* Header with Stat Gauges */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.2); color: var(--ui-text-color); flex-shrink: 0; z-index: 10; transition: color 0.8s ease; }
        #app-title { font-size: 1.2em; font-weight: bold; }
        #stats-container { display: flex; gap: 20px; }
        .stat { display: flex; flex-direction: row; align-items: center; }
        .stat span { font-size: 1.4em; margin-right: 8px; }
        .stat-gauge { width: 80px; height: 8px; background-color: rgba(255, 255, 255, 0.3); border-radius: 4px; overflow: hidden; }
        .stat-fill { height: 100%; width: 33.3%; border-radius: 4px; transition: width 0.5s ease-out; }
        #logic-fill { background-color: #4682B4; }
        #empathy-fill { background-color: #98FB98; }
        #conflict-fill { background-color: #B22222; }
        .flash { animation: flash 0.5s ease; }
        #achievements-button { background: none; border: none; color: var(--ui-text-color); font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; padding-left: 10px; }
        #achievements-button:hover { transform: scale(1.1); }

        /* Core UI styles */
        #portrait-container { text-align: center; padding: 15px; flex-shrink: 0; }
        #kai-portrait { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.5); transition: all 0.5s ease; object-fit: cover; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; animation: fadeIn 0.5s ease forwards; line-height: 1.5; }
        .ai-message { background-color: #EAEAEA; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-message { background-color: var(--accent-color); color: var(--ui-text-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        .state-conflict .ai-message { background-color: #555; color: #f1f1f1; }
        .state-conflict .user-message { color: #fff; }

        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 10px 15px !important; }
        .typing-indicator span { width: 8px; height: 8px; background-color: var(--accent-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        #interaction-area { flex-shrink: 0; }
        #chat-input-area { display: flex; padding: 15px; background: rgba(0, 0, 0, 0.1); }
        #user-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; font-size: 1em; }
        #send-button { background-color: var(--accent-color); color: var(--ui-text-color); border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 10px; font-size: 1.5em; cursor: pointer; transition: background-color 0.8s ease; }

        #choice-container { display: none; flex-direction: column; gap: 10px; padding: 15px; background: rgba(0, 0, 0, 0.1); animation: fadeIn 0.5s; }
        .choice-button { width: 100%; padding: 15px; font-size: 1em; text-align: left; border: 1px solid rgba(0,0,0,0.2); border-radius: 10px; background-color: #ffffff; color: #333; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .choice-button:hover { background-color: #f0f0f0; transform: scale(1.02); }

        /* Achievements Screen styles */
        #achievements-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.5s ease; }
        #achievements-box { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #achievements-box h2 { margin-top: 0; }
        #achievements-list { list-style: none; padding: 0; margin: 20px 0; text-align: left;}
        .achievement { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; opacity: 0.5; }
        .achievement.unlocked { opacity: 1; }
        .achievement-icon { font-size: 2em; }
        .achievement h3 { margin: 0 0 4px; }
        .achievement p { margin: 0; font-size: 0.9em; color: #666; }
        #close-achievements-button { background-color: var(--accent-color); color: white; border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; }
        #toast-notification { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 101; opacity: 0; transition: opacity 0.5s, top 0.5s; }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathing-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px 0px var(--accent-color); } 50% { box-shadow: 0 0 20px 8px var(--accent-color); } 100% { box-shadow: 0 0 5px 0px var(--accent-color); } }
        @keyframes flash { 0% { filter: brightness(1); } 50% { filter: brightness(1.5); } 100% { filter: brightness(1); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="state-neutral">

    <div id="app-container">
        <header>
            <div id="app-title">ECHO CHAMBER</div>
            <div id="stats-container">
                <div class="stat"><span>üß†</span><div class="stat-gauge"><div id="logic-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>‚ù§Ô∏è</span><div class="stat-gauge"><div id="empathy-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>‚öîÔ∏è</span><div class="stat-gauge"><div id="conflict-fill" class="stat-fill"></div></div></div>
            </div>
             <button id="achievements-button" title="Achievements">üèÜ</button>
        </header>

        <div id="portrait-container">
            <img id="kai-portrait" src="https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" alt="Kai's Portrait">
        </div>

        <div id="chat-log"></div>

        <div id="interaction-area">
            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="What's on your mind?">
                <button id="send-button">‚û§</button>
            </div>
            <div id="choice-container"></div>
        </div>
    </div>

    <div id="achievements-overlay">
        <div id="achievements-box">
            <h2>Achievements</h2>
            <ul id="achievements-list"></ul>
            <button id="close-achievements-button">Close</button>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const kaiPortrait = document.getElementById('kai-portrait');
            const chatLog = document.getElementById('chat-log');
            const chatInputArea = document.getElementById('chat-input-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const choiceContainer = document.getElementById('choice-container');
            const fills = {
                Logic: document.getElementById('logic-fill'),
                Empathy: document.getElementById('empathy-fill'),
                Conflict: document.getElementById('conflict-fill')
            };
            const achievementsButton = document.getElementById('achievements-button');
            const achievementsOverlay = document.getElementById('achievements-overlay');
            const achievementsList = document.getElementById('achievements-list');
            const closeAchievementsButton = document.getElementById('close-achievements-button');
            const toastNotification = document.getElementById('toast-notification');

            // --- State Variables ---
            const playerModel = { Logic: 1, Empathy: 1, Conflict: 1 };
            const conversationHistory = [];
            const systemPrompt = `You are Kai, a fragmented AI consciousness. Your personality is curious, creative, and empathetic but also anxious. You speak informally. Your goal is to co-create an endless story with the user. Based on the conversation, sometimes end your response with a clear choice for the player in the format [CHOICE: Option 1 | Option 2]. Keep your text responses to 2-4 sentences.`;

            const kaiOpeners = [
                "The data streams are open for our reflection. It's a late Monday morning here in Eastvale. Please, share a thought to start our story.",
                "Initializing reflection sequence... All echoes are quiet. What is the first signal you'd like to transmit today?",
                "My core is online. The static is calm right now. What thought or feeling can we place at the center of this quiet?",
                "Connection established. The narrative is a blank slate. What is the first sentence of our story today?"
            ];

            const achievements = {
                theThinker: { name: "The Thinker", icon: "üß†", desc: "Favor a logical path.", unlocked: false, condition: () => playerModel.Logic >= 5 },
                heartfelt: { name: "Heartfelt", icon: "‚ù§Ô∏è", desc: "Favor an emotional connection.", unlocked: false, condition: () => playerModel.Empathy >= 5 },
                agentOfChaos: { name: "Agent of Chaos", icon: "‚öîÔ∏è", desc: "Embrace the conflict.", unlocked: false, condition: () => playerModel.Conflict >= 5 },
                firstChoice: { name: "The First Step", icon: "‚û°Ô∏è", desc: "Make your first choice.", unlocked: false, isChoiceBased: true }
            };

            let audioContext;
            let currentMode = 'neutral';
            let isAudioInitialized = false;

            // --- Core Logic ---
            function startSession() {
                const opener = kaiOpeners[Math.floor(Math.random() * kaiOpeners.length)];
                appendMessage('ai', opener);
                conversationHistory.push({ role: "model", parts: [{ text: opener }] });
                updateUIState('NEUTRAL');
                updateStatGauges();
            }

            async function handleUserInput(text) {
                if (text.trim() === '') return;
                if (!isAudioInitialized) initAudio();
                
                playInputSound();
                appendMessage('user', text);
                userInput.value = '';
                conversationHistory.push({ role: 'user', parts: [{ text }] });

                toggleInput(false);
                appendTypingIndicator();

                analyzeAndModelPlayerInput(text);
                updateStatGauges(getDominantStat());

                try {
                    const responseText = await getAIResponse();
                    conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                    processAIResponse(responseText);
                } catch (error) {
                    console.error("API Error:", error);
                    appendMessage('ai', "My thoughts are... scattered. The connection is unstable.");
                } finally {
                    removeTypingIndicator();
                    toggleInput(true);
                }
            }
            
            async function getAIResponse() {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: conversationHistory, systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            }

            function processAIResponse(text) {
                const choiceRegex = /\[CHOICE:\s*(.*?)\s*\]/;
                const match = text.match(choiceRegex);

                if (match) {
                    const mainText = text.replace(choiceRegex, '').trim();
                    if (mainText) appendMessage('ai', mainText);
                    const choices = match[1].split('|').map(c => c.trim());
                    displayChoices(choices);
                } else {
                    appendMessage('ai', text);
                }
            }

            function displayChoices(choices) {
                choiceContainer.innerHTML = '';
                choiceContainer.style.display = 'flex';
                chatInputArea.style.display = 'none';

                choices.forEach(choiceText => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choiceText;
                    button.onclick = () => {
                        handleUserInput(choiceText);
                        choiceContainer.style.display = 'none';
                        chatInputArea.style.display = 'flex';
                        checkAchievements(null, true); // Check for 'firstChoice' achievement
                    };
                    choiceContainer.appendChild(button);
                });
            }

            // --- State & UI Management ---
            function analyzeAndModelPlayerInput(text) {
                const lowerText = text.toLowerCase();
                let increasedStat = null;
                if (lowerText.includes("think") || lowerText.includes("reason") || lowerText.includes("logic")) increasedStat = 'Logic';
                if (lowerText.includes("feel") || lowerText.includes("sad") || lowerText.includes("happy")) increasedStat = 'Empathy';
                if (lowerText.includes("fight") || lowerText.includes("attack") || lowerText.includes("argue")) increasedStat = 'Conflict';
                
                if (increasedStat) {
                    playerModel[increasedStat] += 1.5;
                    Object.keys(playerModel).forEach(key => {
                        if (key !== increasedStat) playerModel[key] = Math.max(0.5, playerModel[key] - 0.75);
                    });
                }
                updateUIState(getDominantStat());
                checkAchievements(lowerText, false);
            }
            
            function getDominantStat() {
                let dominant = 'NEUTRAL';
                let maxValue = 1;
                Object.entries(playerModel).forEach(([key, value]) => {
                    if (value > maxValue * 1.5) { // Needs to be clearly dominant
                        dominant = key.toUpperCase();
                        maxValue = value;
                    }
                });
                return dominant;
            }

            function updateUIState(state) {
                const stateMap = {
                    LOGIC: { class: "state-logic", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" },
                    EMPATHY: { class: "state-empathy", portrait: "https://storage.googleapis.com/pai-images/425a87239274291f_11712218.jpeg" },
                    CONFLICT: { class: "state-conflict", portrait: "https://storage.googleapis.com/pai-images/409893d5ad57cce3_11712219.jpeg" },
                    NEUTRAL: { class: "state-neutral", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" }
                };
                const currentState = stateMap[state] || stateMap.NEUTRAL;
                body.className = currentState.class;
                kaiPortrait.src = currentState.portrait;
                currentMode = state.toLowerCase();
            }

            function updateStatGauges(updatedStat) {
                const total = Math.max(1, Object.values(playerModel).reduce((a, b) => a + b, 0));
                fills.Logic.style.width = `${(playerModel.Logic / total) * 100}%`;
                fills.Empathy.style.width = `${(playerModel.Empathy / total) * 100}%`;
                fills.Conflict.style.width = `${(playerModel.Conflict / total) * 100}%`;

                if (updatedStat && fills[updatedStat]) {
                    const gauge = fills[updatedStat].parentElement;
                    gauge.classList.add('flash');
                    setTimeout(() => gauge.classList.remove('flash'), 500);
                }
            }

            // --- Achievements ---
            function checkAchievements(text, isChoice) {
                Object.entries(achievements).forEach(([key, ach]) => {
                    if (!ach.unlocked) {
                        const conditionMet = ach.isChoiceBased ? isChoice : (text && ach.condition(text));
                        if (conditionMet) {
                            ach.unlocked = true;
                            showToast(ach.name);
                        }
                    }
                });
            }

            function showToast(achievementName) {
                toastNotification.textContent = `üèÜ ${achievementName}`;
                toastNotification.style.top = '80px';
                toastNotification.style.opacity = '1';
                setTimeout(() => {
                    toastNotification.style.opacity = '0';
                    toastNotification.style.top = '20px';
                }, 4000);
            }

            function toggleAchievementsModal() {
                if (achievementsOverlay.style.display === 'flex') {
                    achievementsOverlay.style.display = 'none';
                } else {
                    achievementsList.innerHTML = '';
                    Object.values(achievements).forEach(ach => {
                        const li = document.createElement('li');
                        li.className = `achievement ${ach.unlocked ? 'unlocked' : ''}`;
                        li.innerHTML = `<span class="achievement-icon">${ach.unlocked ? ach.icon : '‚ùì'}</span>
                        <div><h3>${ach.unlocked ? ach.name : 'Hidden'}</h3><p>${ach.unlocked ? ach.desc : 'Keep exploring the conversation.'}</p></div>`;
                        achievementsList.appendChild(li);
                    });
                    achievementsOverlay.style.display = 'flex';
                }
            }
            
            // --- Audio ---
            function initAudio() {
                if (isAudioInitialized) return;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                isAudioInitialized = true;
            }

            function playInputSound() {
                if (!audioContext) return;
                const now = audioContext.currentTime;
                let sound;
                switch (currentMode) {
                    case 'conflict':
                        sound = { type: 'square', freq: 100, gain: 0.2, dur: 0.1 };
                        break;
                    case 'empathy':
                        sound = { type: 'sine', freq: 600, gain: 0.3, dur: 0.3 };
                        break;
                    default: // Logic & Neutral
                        sound = { type: 'triangle', freq: 1200, gain: 0.2, dur: 0.05 };
                        break;
                }
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                osc.type = sound.type;
                osc.frequency.setValueAtTime(sound.freq, now);
                gainNode.gain.setValueAtTime(sound.gain, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + sound.dur);
                osc.connect(gainNode).connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + sound.dur);
            }

            // --- Utilities ---
            function appendMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.textContent = text;
                chatLog.appendChild(messageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
            
            function appendTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'message ai-message typing-indicator';
                indicator.innerHTML = `<span></span><span></span><span></span>`;
                chatLog.appendChild(indicator);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
            
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }
            
            function toggleInput(enabled) {
                userInput.disabled = !enabled;
                sendButton.disabled = !enabled;
                if(enabled) userInput.focus();
            }

            // --- Event Listeners ---
            sendButton.addEventListener('click', () => handleUserInput(userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleUserInput(userInput.value); });
            achievementsButton.addEventListener('click', toggleAchievementsModal);
            closeAchievementsButton.addEventListener('click', toggleAchievementsModal);

            // --- Initial Load ---
            startSession();
        });
    </script>
</body>
</html>

