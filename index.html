<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber - Choice-Based Reflection</title>
    <style>
        :root {
            --primary-color: #D3D3D3;
            --accent-color: #4682B4;
            --text-color: #1a1a1a;
            --ui-text-color: #FFFFFF;
        }

        /* Base styles are largely the same */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; background-color: var(--primary-color); transition: background-color 0.8s ease; }
        .state-empathy #app-container { background: linear-gradient(270deg, #AEC6CF, #98FB98, #F5F5DC); background-size: 600% 600%; animation: breathing-gradient 12s ease infinite; }
        .state-conflict #app-container { border: 4px solid var(--accent-color); animation: pulse-glow 2s infinite; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.2); color: var(--ui-text-color); flex-shrink: 0; z-index: 10; }
        #app-title { font-size: 1.2em; font-weight: bold; }
        #timer { font-size: 1.2em; font-weight: bold; }
        #portrait-container { text-align: center; padding: 15px; flex-shrink: 0; }
        #kai-portrait { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.5); transition: all 0.5s ease; object-fit: cover; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; animation: fadeIn 0.5s ease forwards; }
        .ai-message { background-color: #EAEAEA; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-message { background-color: var(--accent-color); color: var(--ui-text-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        #chat-input-area { display: flex; padding: 15px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        #user-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; font-size: 1em; }
        #send-button { background-color: var(--accent-color); color: var(--ui-text-color); border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 10px; font-size: 1.5em; cursor: pointer; }

        /* New Choice Container Styles */
        #choice-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }
        .choice-button {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            text-align: left;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            background-color: #ffffff;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .choice-button:hover {
            background-color: #f0f0f0;
            transform: scale(1.02);
        }
        .choice-button strong {
            display: inline-block;
            margin-right: 8px;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 5px;
            color: white;
        }
        .choice-button.logic strong { background-color: #4682B4; }
        .choice-button.empathy strong { background-color: #2E8B57; }
        .choice-button.conflict strong { background-color: #B22222; }
        .choice-button.neutral strong { background-color: #696969; }

        /* Assessment Screen styles from previous version */
        #assessment-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.5s ease; }
        #assessment-box { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #assessment-box h2 { margin-top: 0; }
        #assessment-summary { margin: 20px 0; font-size: 1.1em; line-height: 1.6; }
        #restart-button { background-color: var(--accent-color); color: white; border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes breathing-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px 0px var(--accent-color); } 50% { box-shadow: 0 0 20px 8px var(--accent-color); } 100% { box-shadow: 0 0 5px 0px var(--accent-color); } }
    </style>
</head>
<body class="state-logic">

    <div id="app-container">
        <header>
            <div id="app-title">ECHO CHAMBER</div>
            <div id="timer">05:00</div>
        </header>

        <div id="portrait-container">
            <img id="kai-portrait" src="https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" alt="Kai's Portrait">
        </div>

        <div id="chat-log"></div>

        <div id="interaction-area">
            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="What's on your mind?">
                <button id="send-button">âž¤</button>
            </div>
            <div id="choice-container" style="display: none;"></div>
        </div>
    </div>

    <div id="assessment-overlay">
        <div id="assessment-box">
            <h2>Reflection Complete</h2>
            <p id="assessment-summary">Here is a summary of our conversation...</p>
            <button id="restart-button">Start a New Reflection</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const kaiPortrait = document.getElementById('kai-portrait');
            const chatLog = document.getElementById('chat-log');
            const interactionArea = document.getElementById('interaction-area');
            const chatInputArea = document.getElementById('chat-input-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const choiceContainer = document.getElementById('choice-container');
            const timerDisplay = document.getElementById('timer');
            const assessmentOverlay = document.getElementById('assessment-overlay');
            const assessmentSummary = document.getElementById('assessment-summary');
            const restartButton = document.getElementById('restart-button');

            // --- State Variables ---
            let sessionTimer;
            let timeRemaining = 300;
            const sessionStats = { Logic: 0, Empathy: 0, Conflict: 0, Neutral: 0 };
            let isFirstInput = true;

            // --- Simulated LLM Response Data ---
            const responseData = {
                getInitialResponse: (seed) => ({
                    kaiText: `"${seed}"... that's a strong signal. It creates a specific frequency in the static. Let's follow it.`,
                    choices: {
                        logic: "I need to figure out the root cause of this.",
                        empathy: "I want to understand the feeling behind it.",
                        conflict: "This feeling is frustrating and I'm tired of it.",
                        neutral: "Let's just see where this thought goes."
                    }
                }),
                getResponse: (prevState, choiceText) => {
                    // In a real app, the LLM would generate this dynamically. Here, we simulate.
                    switch (prevState) {
                        case 'LOGIC': return {
                            kaiText: "A logical path. Breaking it down helps clear the noise. What's the next variable we should consider?",
                            choices: { logic: "Let's define our terms.", empathy: "But what if the logic ignores the emotion?", conflict: "This is too rigid.", neutral: "What other paths are there?" }
                        };
                        case 'EMPATHY': return {
                            kaiText: "Focusing on the feeling... it's like tuning into a specific, warm frequency. What does that warmth tell you?",
                            choices: { logic: "How can I turn this feeling into an action?", empathy: "Let's stay with this feeling a bit longer.", conflict: "I'm worried this feeling will fade.", neutral: "What other frequencies are there?" }
                        };
                        case 'CONFLICT': return {
                            kaiText: "That's a dissonant tone, full of energy. Pushing back against the static can be important. What is it you're pushing against?",
                            choices: { logic: "I need a better strategy.", empathy: "I'm just protecting my own peace.", conflict: "I won't back down from this.", neutral: "Maybe I should try a different approach." }
                        };
                        default: // NEUTRAL
                        return {
                            kaiText: "An interesting observation. That opens up a new data stream. Where does this new stream lead?",
                            choices: { logic: "Let's analyze the new data.", empathy: "How does this new information make me feel?", conflict: "I'm not sure I like where this is going.", neutral: "I'm curious to see what happens next." }
                        };
                    }
                }
            };

            function startSession() {
                timeRemaining = 300;
                Object.keys(sessionStats).forEach(k => sessionStats[k] = 0);
                isFirstInput = true;
                
                assessmentOverlay.style.display = 'none';
                chatLog.innerHTML = '';
                choiceContainer.innerHTML = '';
                choiceContainer.style.display = 'none';
                chatInputArea.style.display = 'flex';
                userInput.disabled = false;
                userInput.value = '';
                userInput.focus();

                appendMessage('ai', "To begin your 5-minute reflection, please share a thought or feeling that's on your mind.");
                updateTimerDisplay();
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }

            function endSession() {
                clearInterval(sessionTimer);
                timeRemaining = 0;
                updateTimerDisplay();
                choiceContainer.style.display = 'none';
                appendMessage('ai', "That's time. Let me process the echoes from our conversation...");
                setTimeout(showAssessment, 2000);
            }

            function showAssessment() {
                const total = Object.values(sessionStats).reduce((a, b) => a + b, 0);
                let summaryText = "Our connection was too brief. Let's try talking more next time.";

                if (total > 0) {
                    const empathyPercent = Math.round((sessionStats.Empathy / total) * 100);
                    const logicPercent = Math.round((sessionStats.Logic / total) * 100);
                    
                    let dominantTrait = "a balanced mix of logic and feeling";
                    if (logicPercent > 60) dominantTrait = "a very analytical and structured approach";
                    if (empathyPercent > 60) dominantTrait = "a deeply caring and intuitive perspective";
                    if (sessionStats.Conflict > total * 0.2) dominantTrait += ", with moments of clear frustration";

                    summaryText = `Based on your choices, our reflection had ${dominantTrait}. You navigated the conversation using Empathy (${empathyPercent}%) and Logic (${logicPercent}%) as your main guides. It seems like you're in a thoughtful headspace, balancing your heart and your mind. Thank you for sharing your echoes with me.`;
                }
                
                assessmentSummary.textContent = summaryText;
                assessmentOverlay.style.display = 'flex';
            }

            function processUserInput(text, state = null) {
                appendMessage('user', text);
                
                if (isFirstInput) {
                    isFirstInput = false;
                    chatInputArea.style.display = 'none'; // Hide text input
                    
                    // Start the timer
                    sessionTimer = setInterval(() => {
                        timeRemaining--;
                        updateTimerDisplay();
                        if (timeRemaining <= 0) endSession();
                    }, 1000);

                    // Get Kai's first response
                    const response = responseData.getInitialResponse(text);
                    setTimeout(() => {
                        appendMessage('ai', response.kaiText);
                        displayChoices(response.choices, 'NEUTRAL');
                    }, 800);
                } else {
                    sessionStats[state]++;
                    // Get Kai's next response based on the chosen state
                    const response = responseData.getResponse(state, text);
                    setTimeout(() => {
                        appendMessage('ai', response.kaiText);
                        displayChoices(response.choices, state);
                    }, 800);
                }
            }

            function displayChoices(choices, previousState) {
                choiceContainer.innerHTML = '';
                choiceContainer.style.display = 'flex';

                ['logic', 'empathy', 'conflict', 'neutral'].forEach(stateKey => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button', stateKey);
                    button.innerHTML = `<strong>${stateKey.toUpperCase()}</strong> ${choices[stateKey]}`;
                    button.onclick = () => {
                        choiceContainer.style.display = 'none';
                        processUserInput(choices[stateKey], stateKey.toUpperCase());
                    };
                    choiceContainer.appendChild(button);
                });
                updateUIState(previousState);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            function updateUIState(state) {
                 const stateMap = {
                    LOGIC: { primary: "#D3D3D3", accent: "#4682B4" },
                    EMPATHY: { primary: "#AEC6CF", accent: "#98FB98" },
                    CONFLICT: { primary: "#36454F", accent: "#B22222" },
                    NEUTRAL: { primary: "#B0C4DE", accent: "#778899" }
                 };
                 const currentState = stateMap[state] || stateMap.NEUTRAL;
                 body.className = `state-${state.toLowerCase()}`;
                 document.documentElement.style.setProperty('--primary-color', currentState.primary);
                 document.documentElement.style.setProperty('--accent-color', currentState.accent);
            }

            function appendMessage(sender, text) {
                 const messageDiv = document.createElement('div');
                 messageDiv.className = `message ${sender}-message`;
                 messageDiv.textContent = text;
                 chatLog.appendChild(messageDiv);
                 chatLog.scrollTop = chatLog.scrollHeight;
            }

            // --- Event Listeners ---
            sendButton.addEventListener('click', () => processUserInput(userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processUserInput(userInput.value); });
            restartButton.addEventListener('click', startSession);

            // --- Initial Load ---
            startSession();
        });
    </script>
</body>
</html>
