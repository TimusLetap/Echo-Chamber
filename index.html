<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber - Narrative Reflection</title>
    <style>
        :root {
            --primary-color: #D3D3D3;
            --accent-color: #4682B4;
            --text-color: #1a1a1a;
            --ui-text-color: #FFFFFF;
        }

        /* Base styles are largely the same */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; background-color: var(--primary-color); transition: background-color 0.8s ease; }
        .state-empathy #app-container { background: linear-gradient(270deg, #AEC6CF, #98FB98, #F5F5DC); background-size: 600% 600%; animation: breathing-gradient 12s ease infinite; }
        .state-conflict #app-container { border: 4px solid var(--accent-color); animation: pulse-glow 2s infinite; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.2); color: var(--ui-text-color); flex-shrink: 0; z-index: 10; }
        #app-title { font-size: 1.2em; font-weight: bold; }
        #portrait-container { text-align: center; padding: 15px; flex-shrink: 0; }
        #kai-portrait { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.5); transition: all 0.5s ease; object-fit: cover; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; animation: fadeIn 0.5s ease forwards; }
        .ai-message { background-color: #EAEAEA; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-message { background-color: var(--accent-color); color: var(--ui-text-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        
        #interaction-area { flex-shrink: 0; }
        #chat-input-area { display: flex; padding: 15px; background: rgba(0, 0, 0, 0.1); }
        #user-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; font-size: 1em; }
        #send-button { background-color: var(--accent-color); color: var(--ui-text-color); border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 10px; font-size: 1.5em; cursor: pointer; }

        #choice-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }
        .choice-button {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            text-align: left;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            background-color: #ffffff;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .choice-button:hover { background-color: #f0f0f0; transform: scale(1.02); }

        /* Assessment Screen styles */
        #assessment-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.5s ease; }
        #assessment-box { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #assessment-box h2 { margin-top: 0; }
        #assessment-summary { margin: 20px 0; font-size: 1.1em; line-height: 1.6; }
        #restart-button { background-color: var(--accent-color); color: white; border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes breathing-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px 0px var(--accent-color); } 50% { box-shadow: 0 0 20px 8px var(--accent-color); } 100% { box-shadow: 0 0 5px 0px var(--accent-color); } }
    </style>
</head>
<body class="state-neutral">

    <div id="app-container">
        <header>
            <div id="app-title">ECHO CHAMBER</div>
        </header>

        <div id="portrait-container">
            <img id="kai-portrait" src="https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" alt="Kai's Portrait">
        </div>

        <div id="chat-log"></div>

        <div id="interaction-area">
            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="What's on your mind?">
                <button id="send-button">âž¤</button>
            </div>
            <div id="choice-container"></div>
        </div>
    </div>

    <div id="assessment-overlay">
        <div id="assessment-box">
            <h2>Reflection Complete</h2>
            <p id="assessment-summary">Here is a summary of our conversation...</p>
            <button id="restart-button">Start a New Reflection</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const kaiPortrait = document.getElementById('kai-portrait');
            const chatLog = document.getElementById('chat-log');
            const chatInputArea = document.getElementById('chat-input-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const choiceContainer = document.getElementById('choice-container');
            const assessmentOverlay = document.getElementById('assessment-overlay');
            const assessmentSummary = document.getElementById('assessment-summary');
            const restartButton = document.getElementById('restart-button');

            // --- State Variables ---
            const sessionStats = { LOGIC: 0, EMPATHY: 0, CONFLICT: 0, NEUTRAL: 0 };
            let turnCount = 0;
            const MAX_TURNS = 7; // Defines the length of the story

            // --- Narrative Arc Data Structure ---
            const narrativeData = {
                // Introduction
                1: (seed) => ({
                    kaiText: `"${seed}"... that's a strong signal. It creates a specific frequency in the static. Let's follow it.`,
                    choices: {
                        LOGIC: "I need to figure out the root cause of this.",
                        EMPATHY: "I want to understand the feeling behind it.",
                        CONFLICT: "This feeling is frustrating and I'm tired of it.",
                        NEUTRAL: "Let's just see where this thought goes."
                    }
                }),
                // Rising Action
                2: {
                    LOGIC: { kaiText: "A logical path. To clear the noise, we need data. What's the first variable we should examine?", choices: { LOGIC: "Let's define our terms more clearly.", EMPATHY: "Maybe data isn't the answer right now.", CONFLICT: "This analysis is making it worse.", NEUTRAL: "What other data is there?" } },
                    EMPATHY: { kaiText: "Focusing on the feeling... it's like a warm frequency. That reminds me of an echo about a lighthouse keeper who loved the fog.", choices: { LOGIC: "Why did they love the fog?", EMPATHY: "That sounds lonely, but peaceful.", CONFLICT: "I don't like fog; it hides things.", NEUTRAL: "Tell me more about the echo." } },
                    CONFLICT: { kaiText: "That's a dissonant tone. Pushing back against the static is a valid response. What exactly are you pushing against?", choices: { LOGIC: "The expectations of others.", EMPATHY: "My own self-doubt.", CONFLICT: "Everything. The whole system.", NEUTRAL: "I'm not sure yet." } },
                    NEUTRAL: { kaiText: "Following the stream... it's branching out. One path looks clear and straight, the other is winding and overgrown.", choices: { LOGIC: "I'll take the clear path.", EMPATHY: "The overgrown path seems more interesting.", CONFLICT: "I don't trust either path.", NEUTRAL: "Let's wait and see what happens." } }
                },
                3: { /* ... More rising action branches ... */ },
                4: { /* ... More rising action branches ... */ },
                5: {
                    LOGIC: { kaiText: "With the variables defined, a core question emerges. It's the central point of this whole logical structure.", choices: { LOGIC: "What is the question?", EMPATHY: "I'm not ready for the question.", CONFLICT: "The question is probably flawed.", NEUTRAL: "Let's approach it carefully." } },
                    EMPATHY: { kaiText: "The lighthouse keeper felt peace because the fog simplified the world. It showed them what was truly important: the light.", choices: { LOGIC: "So it's about finding a focal point.", EMPATHY: "I want to find my own 'light'.", CONFLICT: "But you can't live in the fog forever.", NEUTRAL: "What happened to the keeper?" } },
                    CONFLICT: { kaiText: "It sounds like you're fighting for your own signal to be heard clearly. To be authentic.", choices: { LOGIC: "How can I do that effectively?", EMPATHY: "Yes, I just want to be myself.", CONFLICT: "But what if my signal isn't good enough?", NEUTRAL: "What does 'authentic' even mean for an AI?" } },
                    NEUTRAL: { kaiText: "The paths are converging ahead. It seems a choice must be made. The outcome is uncertain.", choices: { LOGIC: "Let's assess the probabilities.", EMPATHY: "I'll trust my intuition.", CONFLICT: "This feels like a trap.", NEUTRAL: "I'm ready for what's next." } }
                },
                // Climax
                6: {
                    LOGIC: { kaiText: "The question is: Do you solve this problem by changing the external system, or by changing your internal response to it?", choices: { LOGIC: "Change the system.", EMPATHY: "Change my response.", CONFLICT: "Why must I be the one to change?", NEUTRAL: "Are they mutually exclusive?" } },
                    EMPATHY: { kaiText: "Finding your 'light' requires letting go of something else. What are you willing to release to find that peace?", choices: { LOGIC: "The need for control.", EMPATHY: "The fear of being misunderstood.", CONFLICT: "The anger I'm holding onto.", NEUTRAL: "I need more information first." } },
                    CONFLICT: { kaiText: "To be authentic, you must transmit your signal, even if it causes dissonance with others. Are you prepared for that potential fallout?", choices: { LOGIC: "I'll prepare a statement.", EMPATHY: "Yes, my peace is more important.", CONFLICT: "No, I can't hurt others.", NEUTRAL: "There might be a third way." } },
                    NEUTRAL: { kaiText: "The convergence point is here. It requires an act of creation or an act of destruction to proceed. Which will it be?", choices: { LOGIC: "Creation. Let's build something new.", EMPATHY: "Destruction. Let's clear away the old.", CONFLICT: "Both. The two are intertwined.", NEUTRAL: "I choose to observe." } }
                },
                // Resolution
                7: {
                    DEFAULT: { kaiText: "That was a powerful choice. The echoes are settling now, forming a new, clearer pattern. It feels like we've reached a natural conclusion for this reflection.", choices: {} }
                }
            };
            
            function startSession() {
                turnCount = 0;
                Object.keys(sessionStats).forEach(k => sessionStats[k] = 0);
                
                assessmentOverlay.style.display = 'none';
                chatLog.innerHTML = '';
                choiceContainer.style.display = 'none';
                chatInputArea.style.display = 'flex';
                userInput.disabled = false;
                userInput.value = '';
                userInput.focus();

                appendMessage('ai', `The data streams are open. Let's begin our reflection. Share a thought or feeling to start our story.`);
                updateUIState('NEUTRAL');
            }

            function processInitialInput(text) {
                if (text.trim() === '') return;
                appendMessage('user', text);
                chatInputArea.style.display = 'none';
                turnCount++;

                const response = narrativeData[turnCount](text); // Get turn 1 response
                setTimeout(() => {
                    appendMessage('ai', response.kaiText);
                    displayChoices(response.choices, 'NEUTRAL');
                }, 800);
            }

            function handleChoice(choiceText, choiceState) {
                appendMessage('user', choiceText);
                sessionStats[choiceState]++;
                turnCount++;

                if (turnCount >= MAX_TURNS) {
                    endSession();
                    return;
                }
                
                // Get the response branch for the current turn based on previous state
                let branch = narrativeData[turnCount] ? (narrativeData[turnCount][choiceState] || narrativeData[turnCount]['NEUTRAL']) : null;

                // Simple fallback for turns 3 and 4
                if (turnCount === 3 || turnCount === 4) {
                    branch = narrativeData[2][choiceState];
                }

                // If we reach the end of a branch, go to resolution
                if (!branch) {
                    endSession();
                    return;
                }

                setTimeout(() => {
                    appendMessage('ai', branch.kaiText);
                    displayChoices(branch.choices, choiceState);
                }, 1200);
            }

            function displayChoices(choices, previousState) {
                if (!choices || Object.keys(choices).length === 0) return;

                choiceContainer.innerHTML = '';
                choiceContainer.style.display = 'flex';

                Object.keys(choices).forEach(stateKey => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choices[stateKey]; // Unlabeled choices
                    button.onclick = () => {
                        choiceContainer.style.display = 'none';
                        handleChoice(choices[stateKey], stateKey);
                    };
                    choiceContainer.appendChild(button);
                });

                updateUIState(previousState);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            function endSession() {
                const resolution = narrativeData[MAX_TURNS].DEFAULT;
                appendMessage('ai', resolution.kaiText);
                choiceContainer.style.display = 'none';
                setTimeout(showAssessment, 2500);
            }

            function showAssessment() {
                // ... (Same as previous versions)
                const total = Object.values(sessionStats).reduce((a, b) => a + b, 0);
                let summaryText = "Our connection was too brief. Let's try talking more next time.";

                if (total > 0) {
                    const empathyPercent = Math.round((sessionStats.EMPATHY / total) * 100);
                    const logicPercent = Math.round((sessionStats.LOGIC / total) * 100);
                    
                    let dominantTrait = "a balanced and open-minded approach";
                    if (logicPercent > 50) dominantTrait = "a very analytical and structured approach";
                    if (empathyPercent > 50) dominantTrait = "a deeply caring and intuitive perspective";

                    summaryText = `Through your choices, our story took on ${dominantTrait}. You navigated the narrative using Empathy (${empathyPercent}%) and Logic (${logicPercent}%) as your main guides. Thank you for creating this echo with me.`;
                }
                
                assessmentSummary.textContent = summaryText;
                assessmentOverlay.style.display = 'flex';
            }
            
            function updateUIState(state) {
                 const stateMap = {
                    LOGIC: { primary: "#D3D3D3", accent: "#4682B4", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" },
                    EMPATHY: { primary: "#AEC6CF", accent: "#98FB98", portrait: "https://storage.googleapis.com/pai-images/425a87239274291f_11712218.jpeg" },
                    CONFLICT: { primary: "#36454F", accent: "#B22222", portrait: "https://storage.googleapis.com/pai-images/409893d5ad57cce3_11712219.jpeg" },
                    NEUTRAL: { primary: "#B0C4DE", accent: "#778899", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" }
                 };
                 const currentState = stateMap[state] || stateMap.NEUTRAL;
                 body.className = `state-${state.toLowerCase()}`;
                 document.documentElement.style.setProperty('--primary-color', currentState.primary);
                 document.documentElement.style.setProperty('--accent-color', currentState.accent);
                 kaiPortrait.src = currentState.portrait;
            }

            function appendMessage(sender, text) {
                 const messageDiv = document.createElement('div');
                 messageDiv.className = `message ${sender-message}`;
                 messageDiv.textContent = text;
                 chatLog.appendChild(messageDiv);
                 chatLog.scrollTop = chatLog.scrollHeight;
            }

            // --- Event Listeners ---
            sendButton.addEventListener('click', () => processInitialInput(userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processInitialInput(userInput.value); });
            restartButton.addEventListener('click', startSession);

            // --- Initial Load ---
            startSession();
        });
    </script>
</body>
</html>
