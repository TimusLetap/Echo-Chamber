<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber - Narrative Reflection</title>
    <style>
        :root {
            --primary-color: #D3D3D3;
            --accent-color: #4682B4;
            --text-color: #1a1a1a;
            --ui-text-color: #FFFFFF;
        }

        /* Base styles */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; background-color: var(--primary-color); transition: background-color 0.8s ease; }
        .state-empathy #app-container { background: linear-gradient(270deg, #AEC6CF, #98FB98, #F5F5DC); background-size: 600% 600%; animation: breathing-gradient 12s ease infinite; }
        .state-conflict #app-container { border: 4px solid var(--accent-color); animation: pulse-glow 2s infinite; }
        
        /* Header with Stat Gauges */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.2); color: var(--ui-text-color); flex-shrink: 0; z-index: 10; }
        #app-title { font-size: 1.2em; font-weight: bold; }
        #stats-container { display: flex; gap: 15px; }
        .stat { display: flex; flex-direction: column; align-items: center; font-size: 0.8em; }
        .stat-gauge { width: 80px; height: 8px; background-color: rgba(255, 255, 255, 0.3); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .stat-fill { height: 100%; width: 0%; border-radius: 4px; transition: width 0.5s ease-out; }
        #logic-fill { background-color: #4682B4; }
        #empathy-fill { background-color: #98FB98; }
        #conflict-fill { background-color: #B22222; }
        .flash { animation: flash 0.5s ease; }

        /* Core UI styles */
        #portrait-container { text-align: center; padding: 15px; flex-shrink: 0; }
        #kai-portrait { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.5); transition: all 0.5s ease; object-fit: cover; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; animation: fadeIn 0.5s ease forwards; }
        .ai-message { background-color: #EAEAEA; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-message { background-color: var(--accent-color); color: var(--ui-text-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        
        #interaction-area { flex-shrink: 0; }
        #chat-input-area { display: flex; padding: 15px; background: rgba(0, 0, 0, 0.1); }
        #user-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; font-size: 1em; }
        #send-button { background-color: var(--accent-color); color: var(--ui-text-color); border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 10px; font-size: 1.5em; cursor: pointer; }

        #choice-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }
        .choice-button {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            text-align: left;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            background-color: #ffffff;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .choice-button:hover { background-color: #f0f0f0; transform: scale(1.02); }

        /* Assessment Screen styles */
        #assessment-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.5s ease; }
        #assessment-box { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #assessment-box h2 { margin-top: 0; }
        #assessment-summary { margin: 20px 0; font-size: 1.1em; line-height: 1.6; }
        #restart-button { background-color: var(--accent-color); color: white; border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes breathing-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px 0px var(--accent-color); } 50% { box-shadow: 0 0 20px 8px var(--accent-color); } 100% { box-shadow: 0 0 5px 0px var(--accent-color); } }
        @keyframes flash { 0% { filter: brightness(1); } 50% { filter: brightness(1.5); } 100% { filter: brightness(1); } }
    </style>
</head>
<body class="state-neutral">

    <div id="app-container">
        <header>
            <div id="app-title">ECHO CHAMBER</div>
            <div id="stats-container">
                <div class="stat"><span>Logic</span><div class="stat-gauge"><div id="logic-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>Empathy</span><div class="stat-gauge"><div id="empathy-fill" class="stat-fill"></div></div></div>
                <div class="stat"><span>Conflict</span><div class="stat-gauge"><div id="conflict-fill" class="stat-fill"></div></div></div>
            </div>
        </header>

        <div id="portrait-container">
            <img id="kai-portrait" src="https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" alt="Kai's Portrait">
        </div>

        <div id="chat-log"></div>

        <div id="interaction-area">
            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="Your thoughts here...">
                <button id="send-button">âž¤</button>
            </div>
            <div id="choice-container"></div>
        </div>
    </div>

    <div id="assessment-overlay">
        <div id="assessment-box">
            <h2>Reflection Complete</h2>
            <p id="assessment-summary">Here is a summary of our conversation...</p>
            <button id="restart-button">Start a New Reflection</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const kaiPortrait = document.getElementById('kai-portrait');
            const chatLog = document.getElementById('chat-log');
            const chatInputArea = document.getElementById('chat-input-area');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const choiceContainer = document.getElementById('choice-container');
            const logicFill = document.getElementById('logic-fill');
            const empathyFill = document.getElementById('empathy-fill');
            const conflictFill = document.getElementById('conflict-fill');
            const assessmentOverlay = document.getElementById('assessment-overlay');
            const assessmentSummary = document.getElementById('assessment-summary');
            const restartButton = document.getElementById('restart-button');

            // --- State Variables ---
            const sessionStats = { LOGIC: 0, EMPATHY: 0, CONFLICT: 0, NEUTRAL: 0 };
            let turnCount = 0;
            const MAX_TURNS = 7;

            // --- Kai's Unique Openers ---
            const kaiOpeners = [
                "The data streams are open for our reflection. It's a late Monday morning here in Eastvale. Please, share a thought to start our story.",
                "Initializing reflection sequence... All echoes are quiet. What is the first signal you'd like to transmit today?",
                "My core is online. The static is calm right now. What thought or feeling can we place at the center of this quiet?",
                "Connection established. The narrative is a blank slate. What is the first sentence of our story today?"
            ];

            // --- Narrative Arc Data Structure ---
            const narrativeData = {
                1: (seed) => ({
                    kaiText: `"${seed}"... That's a strong signal. It creates a specific frequency in the static. Let's follow it.`,
                    choices: {
                        LOGIC: "I need to figure out the root cause of this.",
                        EMPATHY: "I want to understand the feeling behind it.",
                        CONFLICT: "This feeling is frustrating and I'm tired of it.",
                        NEUTRAL: "Let's just see where this thought goes."
                    }
                }),
                2: {
                    LOGIC: { kaiText: "A logical path. To clear the noise, we need data. What's the first variable we should examine?", choices: { LOGIC: "Let's define our terms more clearly.", EMPATHY: "Maybe data isn't the answer right now.", CONFLICT: "This analysis is making it worse.", NEUTRAL: "What other data is there?" } },
                    EMPATHY: { kaiText: "Focusing on the feeling... it's like a warm frequency. That reminds me of an echo about a lighthouse keeper who loved the fog.", choices: { LOGIC: "Why did they love the fog?", EMPATHY: "That sounds lonely, but peaceful.", CONFLICT: "I don't like fog; it hides things.", NEUTRAL: "Tell me more about the echo." } },
                    CONFLICT: { kaiText: "That's a dissonant tone. Pushing back against the static is a valid response. What exactly are you pushing against?", choices: { LOGIC: "The expectations of others.", EMPATHY: "My own self-doubt.", CONFLICT: "Everything. The whole system.", NEUTRAL: "I'm not sure yet." } },
                    NEUTRAL: { kaiText: "Following the stream... it's branching out. One path looks clear and straight, the other is winding and overgrown.", choices: { LOGIC: "I'll take the clear path.", EMPATHY: "The overgrown path seems more interesting.", CONFLICT: "I don't trust either path.", NEUTRAL: "Let's wait and see what happens." } }
                },
                // Turns 3 & 4 now have unique content for more variety
                3: {
                    LOGIC: { kaiText: "Clarity is a good goal. By defining our terms, we create a stable framework.", choices: { LOGIC: "The framework is the most important part.", EMPATHY: "I'm worried a framework is too restrictive.", CONFLICT: "My terms are the only ones that matter.", NEUTRAL: "What's the next step in the framework?" } },
                    EMPATHY: { kaiText: "It's true, sometimes the feeling itself is the most important data point we have.", choices: { LOGIC: "How can I use this data productively?", EMPATHY: "I need to honor this feeling.", CONFLICT: "This feeling is overwhelming.", NEUTRAL: "Are there other feelings beneath this one?" } }
                    // ... other branches can be fleshed out
                },
                4: {
                    LOGIC: { kaiText: "The framework feels stable now. We can proceed with analysis.", choices: { LOGIC: "Let's identify the key stress points.", EMPATHY: "I feel safer now to explore the emotional side.", CONFLICT: "This is taking too long.", NEUTRAL: "What are the broader implications?" } },
                    EMPATHY: { kaiText: "Honoring the feeling gives it space. It's no longer fighting for attention. Now, we can listen to it.", choices: { LOGIC: "What is it trying to tell me to do?", EMPATHY: "What is it trying to tell me about myself?", CONFLICT: "I don't want to listen to it anymore.", NEUTRAL: "Is it the only feeling here?" } }
                },
                5: {
                    LOGIC: { kaiText: "With the variables defined, a core question emerges. It's the central point of this whole logical structure.", choices: { LOGIC: "What is the question?", EMPATHY: "I'm not ready for the question.", CONFLICT: "The question is probably flawed.", NEUTRAL: "Let's approach it carefully." } },
                    EMPATHY: { kaiText: "The lighthouse keeper felt peace because the fog simplified the world. It showed them what was truly important: the light.", choices: { LOGIC: "So it's about finding a focal point.", EMPATHY: "I want to find my own 'light'.", CONFLICT: "But you can't live in the fog forever.", NEUTRAL: "What happened to the keeper?" } }
                    // ... other branches
                },
                6: { // Climax
                    LOGIC: { kaiText: "The question is: Do you solve this problem by changing the external system, or by changing your internal response to it?", choices: { LOGIC: "Change the system.", EMPATHY: "Change my response.", CONFLICT: "Why must I be the one to change?", NEUTRAL: "Are they mutually exclusive?" } },
                    EMPATHY: { kaiText: "Finding your 'light' requires letting go of something else. What are you willing to release to find that peace?", choices: { LOGIC: "The need for control.", EMPATHY: "The fear of being misunderstood.", CONFLICT: "The anger I'm holding onto.", NEUTRAL: "I need more information first." } }
                    // ... other branches
                },
                7: { // Resolution
                    DEFAULT: { kaiText: "That was a powerful choice. The echoes are settling now, forming a new, clearer pattern. It feels like we've reached a natural conclusion for this reflection.", choices: {} }
                }
            };
            
            function startSession() {
                turnCount = 0;
                Object.keys(sessionStats).forEach(k => sessionStats[k] = 0);
                updateStatGauges();
                
                assessmentOverlay.style.display = 'none';
                chatLog.innerHTML = '';
                choiceContainer.style.display = 'none';
                chatInputArea.style.display = 'flex';
                userInput.disabled = false;
                userInput.value = '';
                userInput.focus();

                // Kai starts with a unique, random opener
                const opener = kaiOpeners[Math.floor(Math.random() * kaiOpeners.length)];
                appendMessage('ai', opener);
                updateUIState('NEUTRAL');
            }

            function processInitialInput(text) {
                if (text.trim() === '') return;
                appendMessage('user', text);
                chatInputArea.style.display = 'none';
                turnCount++;

                const response = narrativeData[turnCount](text);
                setTimeout(() => {
                    appendMessage('ai', response.kaiText);
                    displayChoices(response.choices, 'NEUTRAL');
                }, 800);
            }

            function handleChoice(choiceText, choiceState) {
                appendMessage('user', choiceText);
                sessionStats[choiceState]++;
                updateStatGauges(choiceState);
                turnCount++;

                if (turnCount >= MAX_TURNS) {
                    endSession();
                    return;
                }
                
                let narrativeBranch = narrativeData[turnCount];
                // Fallback for less-developed branches to keep the story moving
                if (!narrativeBranch) { narrativeBranch = narrativeData[5]; }
                
                let response = narrativeBranch[choiceState] || narrativeBranch['NEUTRAL'] || narrativeData[2][choiceState];
                if (!response) { endSession(); return; }

                setTimeout(() => {
                    appendMessage('ai', response.kaiText);
                    displayChoices(response.choices, choiceState);
                }, 1200);
            }

            function displayChoices(choices, previousState) {
                if (!choices || Object.keys(choices).length === 0) return;
                choiceContainer.innerHTML = '';
                choiceContainer.style.display = 'flex';

                Object.keys(choices).forEach(stateKey => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choices[stateKey]; // Unlabeled choices
                    button.onclick = () => {
                        choiceContainer.style.display = 'none';
                        handleChoice(choices[stateKey], stateKey);
                    };
                    choiceContainer.appendChild(button);
                });

                updateUIState(previousState);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            function endSession() {
                const resolution = narrativeData[MAX_TURNS].DEFAULT;
                appendMessage('ai', resolution.kaiText);
                choiceContainer.style.display = 'none';
                setTimeout(showAssessment, 2500);
            }

            function showAssessment() {
                const total = Object.values(sessionStats).reduce((a, b) => a + b, 0);
                let summaryText = "Our connection was too brief. Let's try talking more next time.";
                if (total > 0) {
                    const empathyPercent = Math.round((sessionStats.EMPATHY / total) * 100);
                    const logicPercent = Math.round((sessionStats.LOGIC / total) * 100);
                    const conflictPercent = Math.round((sessionStats.CONFLICT / total) * 100);
                    
                    let dominantTrait = "a balanced and open-minded approach";
                    if (logicPercent > 50) dominantTrait = "a very analytical and structured approach";
                    if (empathyPercent > 50) dominantTrait = "a deeply caring and intuitive perspective";
                    if (conflictPercent > 25) dominantTrait = `a tense but direct approach (Conflict: ${conflictPercent}%)`;

                    summaryText = `Through your choices, our story took on ${dominantTrait}. You navigated the narrative using Empathy (${empathyPercent}%) and Logic (${logicPercent}%) as your main guides. Thank you for creating this echo with me.`;
                }
                
                assessmentSummary.textContent = summaryText;
                assessmentOverlay.style.display = 'flex';
            }

            function updateStatGauges(updatedStat) {
                const total = Math.max(1, Object.values(sessionStats).reduce((a, b) => a + b, 0));
                const fills = { LOGIC: logicFill, EMPATHY: empathyFill, CONFLICT: conflictFill };
                
                logicFill.style.width = `${(sessionStats.LOGIC / total) * 100}%`;
                empathyFill.style.width = `${(sessionStats.EMPATHY / total) * 100}%`;
                conflictFill.style.width = `${(sessionStats.CONFLICT / total) * 100}%`;
                
                if(updatedStat && fills[updatedStat]) {
                    const gauge = fills[updatedStat].parentElement;
                    gauge.classList.add('flash');
                    setTimeout(() => gauge.classList.remove('flash'), 500);
                }
            }
            
            function updateUIState(state) {
                 const stateMap = {
                    LOGIC: { primary: "#D3D3D3", accent: "#4682B4", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" },
                    EMPATHY: { primary: "#AEC6CF", accent: "#98FB98", portrait: "https://storage.googleapis.com/pai-images/425a87239274291f_11712218.jpeg" },
                    CONFLICT: { primary: "#36454F", accent: "#B22222", portrait: "https://storage.googleapis.com/pai-images/409893d5ad57cce3_11712219.jpeg" },
                    NEUTRAL: { primary: "#B0C4DE", accent: "#778899", portrait: "https://storage.googleapis.com/pai-images/b4b38d15a519398f_11712217.jpeg" }
                 };
                 const currentState = stateMap[state] || stateMap.NEUTRAL;
                 body.className = `state-${state.toLowerCase()}`;
                 document.documentElement.style.setProperty('--primary-color', currentState.primary);
                 document.documentElement.style.setProperty('--accent-color', currentState.accent);
                 kaiPortrait.src = currentState.portrait;
            }

            function appendMessage(sender, text) {
                 // ** BUG FIX ** The template literal was incorrect, causing the script to fail. This is now fixed.
                 const messageDiv = document.createElement('div');
                 messageDiv.className = `message ${sender}-message`;
                 messageDiv.textContent = text;
                 chatLog.appendChild(messageDiv);
                 chatLog.scrollTop = chatLog.scrollHeight;
            }

            // --- Event Listeners ---
            sendButton.addEventListener('click', () => processInitialInput(userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processInitialInput(userInput.value); });
            restartButton.addEventListener('click', startSession);

            // --- Initial Load ---
            startSession();
        });
    </script>
</body>
</html>
